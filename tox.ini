[tox]
envlist = py{39,310,311,312}, openllm-async-tests
skipsdist = True

[testenv]
deps = 
    -e .[testing]
commands = 
    pytest {posargs}

[testenv:openllm-async-tests]
deps = 
    -e .[testing]
    pytest-asyncio>=0.21.1
    httpx
    pytest-cov>=4.1.0
commands = 
    pytest tests/unit/test_openllm_run.py --cov=bentoml.openllm --cov-fail-under=90 --cov-report=term-missing -v --timeout=60
setenv =
    PYTEST_TIMEOUT = 60
passenv = *
enable_parallel = true

[testenv:transformers-local]
deps = 
    -e .[testing]
    pytest-asyncio>=0.21.1
    transformers
    torch
    tokenizers
    pytest-cov>=4.1.0
commands = 
    pytest tests/integration/frameworks/test_transformers_async.py --cov=bentoml._internal.frameworks.transformers --cov-report=term-missing -v --timeout=300

[testenv:lint]
deps = 
    ruff
    black
    mypy
commands = 
    ruff check src/ tests/
    black --check src/ tests/
    mypy src/

[testenv:format]
deps = 
    ruff
    black
commands = 
    ruff check --fix src/ tests/
    black src/ tests/

[coverage:run]
branch = True
source = bentoml
omit = 
    */tests/*
    */__pycache__/*
    */site-packages/*

[coverage:report]
exclude_lines = 
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
precision = 2