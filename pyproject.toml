[project]
name = "bentoml"
description = "BentoML: The Unified Model Serving Framework"
readme = { file = "README.md", content-type = "text/markdown" }
requires-python = ">=3.7"
keywords = ["MLOps", "AI", "BentoML", "Model Serving", "Model Deployment"]
license = { file = "LICENSE" }
authors = [{ name = "BentoML Team", email = "contact@bentoml.com" }]
classifiers = [
  "License :: OSI Approved :: Apache Software License",
  "Operating System :: OS Independent",
  "Programming Language :: Python :: 3",
  "Programming Language :: Python :: 3 :: Only",
  "Programming Language :: Python :: 3.7",
  "Programming Language :: Python :: 3.8",
  "Programming Language :: Python :: 3.9",
  "Programming Language :: Python :: 3.10",
  "Programming Language :: Python :: Implementation :: CPython",
  "Topic :: Scientific/Engineering :: Artificial Intelligence",
  "Topic :: Software Development :: Libraries",
]
dependencies = [
  "Jinja2>=3.0.1",
  "PyYAML>=5.0",
  "aiohttp",
  "attrs>=21.1.0",
  "cattrs>=22.1.0",
  "certifi",
  "circus",
  # minimum Click support for python 3.7
  "click>=8.1.0",
  "cloudpickle",
  "deepmerge",
  "fs",
  "numpy",
  "opentelemetry-api==1.9.0",
  "opentelemetry-instrumentation==0.28b0",
  "opentelemetry-instrumentation-aiohttp-client==0.28b0",
  "opentelemetry-instrumentation-asgi==0.28b0",
  "opentelemetry-sdk==1.9.0",
  "opentelemetry-semantic-conventions==0.28b0",
  "opentelemetry-util-http==0.28b0",
  "packaging>=20.0",
  "pathspec",
  "pip-tools>=6.6.2",
  "prometheus-client>=0.10.0,<0.14.0",
  "psutil",
  "pynvml<12",
  "python-dateutil",
  "python-dotenv>=0.20.0",
  "python-multipart",
  "requests",
  "rich>=11.2.0",
  "schema",
  "simple-di>=0.1.4",
  "starlette",
  "uvicorn",
  "watchfiles>=0.15.0",
  'backports.cached-property;python_version<"3.8"',
  'importlib-metadata;python_version<"3.8"',
]
dynamic = ["version"]

[tool.setuptools.dynamic.version]
# version is generated by setuptools_scm
attr = "bentoml._version.__version__"

[project.scripts]
bentoml = "bentoml_cli.cli:cli"

[project.urls]
"Documentation" = "https://docs.bentoml.org/en/latest/"
"Bug Reports" = "https://github.com/bentoml/BentoML/issues"
"BentoML Community Slack" = "https://bit.ly/2N5IpbB"
"BentoML Official Blog" = "https://modelserving.com"
"BentoML Twitter" = "https://twitter.com/bentomlai"

[project.optional-dependencies]
grpc = [
  # Restrict maximum version due to breaking protobuf 4.21.0 changes
  # (see https://github.com/protocolbuffers/protobuf/issues/10051)
  "protobuf>=3.5.0, <3.20",
  # There is memory leak in later Python GRPC (1.43.0 to be specific),
  # use known working version until the memory leak is resolved in the future
  # (see https://github.com/grpc/grpc/issues/28513)
  # TODO: lock 1.41.0 for non M1 builds, otherwise use latest
  "grpcio",
  "grpcio-health-checking",
  "grpcio-reflection",
  "opentelemetry-instrumentation-grpc==0.28b0",
]
tracing = ["opentelemetry-exporter-jaeger", "opentelemetry-exporter-zipkin"]

[build-system]
requires = [
  "grpcio-tools==1.47.0",
  "mypy-protobuf==3.2.0",
  "protobuf==3.19.4",
  "setuptools==63.4.0",
  "setuptools-scm[toml]>=7.0.0",
  "wheel",
]
build-backend = "setuptools.build_meta"

[tool.setuptools]
include-package-data = true

[tool.setuptools.packages.find]
include = [
  "bentoml",
  "bentoml.grpc*",
  "bentoml.testing",
  "bentoml._internal*",
  "bentoml_cli",
  "bentoml_cli.server",
]
exclude = ["tests"]

[tool.setuptools.package-data]
"*" = ["py.typed", "*.pyi", "*_pb2*.py", "*.j2"]

[tool.setuptools_scm]
write_to = "bentoml/_version.py"
git_describe_command = "git describe --dirty --tags --long --first-parent"
version_scheme = "post-release"
fallback_version = "0.0.0"

[tool.coverage.paths]
source = ["bentoml"]

[tool.coverage.run]
branch = true
source = ["bentoml", "bentoml_cli"]
omit = [
  "bentoml/**/*_pb2.py",
  "bentoml/__main__.py",
  "bentoml/_internal/types.py",
  "bentoml/_internal/external_typing/*",
  "bentoml/testing/*",
  "bentoml/io.py",
]

[tool.coverage.report]
show_missing = true
precision = 2
omit = [
  "bentoml/**/*_pb2*.py",
  "bentoml/_internal/external_typing/*",
  "bentoml/_internal/types.py",
  "bentoml/testing/*",
  'bentoml/__main__.py',
  "bentoml/io.py",
]
exclude_lines = [
  "pragma: no cover",
  "def __repr__",
  "raise AssertionError",
  "raise NotImplementedError",
  "raise MissingDependencyException",
  "except ImportError",
  "if __name__ == .__main__.:",
  "if TYPE_CHECKING:",
]

[tool.black]
line-length = 88
exclude = '''
(
  /(
      \.eggs
    | \.git
    | \.tox
    | \.venv
    | _build
    | build
    | dist
    | typings
    | bentoml/grpc
  )/
  | bentoml/_version.py
)
'''
extend-exclude = "(_pb2.py$|_pb2_grpc.py$)"

[tool.pytest.ini_options]
addopts = "-rfEX -p pytester -p no:warnings -x"
python_files = ["test_*.py", "*_test.py"]
testpaths = ["tests"]
markers = ["gpus"]

[tool.pylint.main]
recursive = true
extension-pkg-allow-list = [
  "numpy",
  "tensorflow",
  "torch",
  "paddle",
  "onnxruntime",
  "onnx",
  "pydantic.schema",
]
ignore-paths = ["typings", "bentoml/_internal/external_typing", "bentoml/grpc"]
disable = [
  "import-error",
  "print-statement",
  "parameter-unpacking",
  "unpacking-in-except",
  "old-raise-syntax",
  "backtick",
  "raw-checker-failed",
  "bad-inline-option",
  "locally-disabled",
  "file-ignored",
  "suppressed-message",
  "useless-suppression",
  "deprecated-pragma",
  "apply-builtin",
  "basestring-builtin",
  "buffer-builtin",
  "cmp-builtin",
  "coerce-builtin",
  "execfile-builtin",
  "file-builtin",
  "long-builtin",
  "raw_input-builtin",
  "reduce-builtin",
  "standarderror-builtin",
  "coerce-method",
  "delslice-method",
  "getslice-method",
  "setslice-method",
  "no-absolute-import",
  "old-division",
  "dict-iter-method",
  "dict-view-method",
  "next-method-called",
  "metaclass-assignment",
  "indexing-exception",
  "raising-string",
  "reload-builtin",
  "oct-method",
  "hex-method",
  "nonzero-method",
  "cmp-method",
  "input-builtin",
  "round-builtin",
  "intern-builtin",
  "unichr-builtin",
  "map-builtin-not-iterating",
  "zip-builtin-not-iterating",
  "range-builtin-not-iterating",
  "filter-builtin-not-iterating",
  "using-cmp-argument",
  "exception-message-attribute",
  "invalid-str-codec",
  "sys-max-int",
  "bad-python3-import",
  "deprecated-string-function",
  "deprecated-str-translate-call",
  "deprecated-itertools-function",
  "deprecated-types-field",
  "next-method-defined",
  "dict-items-not-iterating",
  "dict-keys-not-iterating",
  "dict-values-not-iterating",
  "deprecated-operator-function",
  "deprecated-urllib-function",
  "xreadlines-attribute",
  "deprecated-sys-function",
  "exception-escape",
  "comprehension-escape",
  "logging-fstring-interpolation",
  "logging-format-interpolation",
  "logging-not-lazy",
  "C",
  "R",
  "fixme",
  "protected-access",
  "no-member",
  "unsubscriptable-object",
  "raise-missing-from",
  "isinstance-second-argument-not-valid-type",
]
enable = ["c-extension-no-member"]
evaluation = "10.0 - ((float(5 * error + warning + refactor + convention) / statement) * 10)"
msg-template = "{msg_id}:{symbol} [{line:0>3d}:{column:0>2d}] {obj}: {msg}"
output-format = "colorized"
score = true

[tool.pylint.classes]
valid-metaclass-classmethod-first-arg = ["cls", "mcls", "kls"]

[tool.pylint.logging]
logging-format-style = "new" # using f-string formatter for logging.

[tool.pylint.miscellaneous]
notes = ["FIXME", "XXX", "TODO", "NOTE", "WARNING"]

[tool.pylint.refactoring]
never-returning-functions = [
  "sys.exit",
  "raise_grpc_exception",
] # specify functions that should not return

[tool.pylint.spelling]
spelling-ignore-comment-directives = "fmt: on,fmt: off,noqa:,noqa,nosec,isort:skip,mypy:,pylint:,type:"

[tool.pylint.variables]
allowed-redefined-builtins = ["create_bento_servicer.BentoServiceServicer.Call"]
init-import = true

[tool.isort]
profile = "black"
line_length = 88
length_sort = true
force_single_line = true
order_by_type = true
force_alphabetical_sort_within_sections = true
skip_glob = ["typings/*", "test/*", "**/*_pb2.py", "**/*_pb2_grpc.py"]

[tool.pyright]
pythonVersion = "3.10"
include = ["bentoml"]
exclude = [
  'bentoml/_version.py',
  'bentoml/__main__.py',
  'bentoml/_internal/external_typing',
  'bentoml/grpc',
  '**/*_pb2.py',
  "**/*_pb2_grpc.py",
]
analysis.useLibraryCodeForTypes = true
strictListInference = true
strictDictionaryInference = true
strictSetInference = true
strictParameterNoneValue = true
enableTypeIgnoreComments = true
reportGeneralTypeIssues = "error"
reportPropertyTypeMismatch = "error"
reportFunctionMemberAccess = "error"
reportMissingImports = "warning"
reportMissingModuleSource = "warning"
reportMissingTypeStubs = "warning"
reportUnusedImport = "error"
reportUnusedClass = "error"
reportUnusedFunction = "error"
reportUnusedVariable = "error"
reportDuplicateImport = "error"
reportWildcardImportFromLibrary = "error"
reportOptionalSubscript = "error"
reportOptionalMemberAccess = "error"
reportOptionalCall = "error"
reportOptionalIterable = "error"
reportOptionalContextManager = "error"
reportOptionalOperand = "error"
reportTypedDictNotRequiredAccess = "error"
reportUntypedFunctionDecorator = "error"
reportUntypedClassDecorator = "error"
reportUntypedBaseClass = "error"
reportUntypedNamedTuple = "error"
reportPrivateUsage = "error"
reportPrivateImportUsage = "error"
reportConstantRedefinition = "error"
reportIncompatibleMethodOverride = "error"
reportIncompatibleVariableOverride = "error"
reportOverlappingOverload = "error"
reportUninitializedInstanceVariable = "none"
reportInvalidStringEscapeSequence = "error"
reportUnknownParameterType = "error"
reportUnknownArgumentType = "error"
reportUnknownLambdaType = "error"
reportUnknownVariableType = "error"
reportUnknownMemberType = "warning"
reportMissingParameterType = "error"
reportMissingTypeArgument = "error"
reportInvalidTypeVarUse = "error"
reportCallInDefaultInitializer = "none"
reportUnnecessaryIsInstance = "warning"
reportUnnecessaryCast = "error"
reportUnnecessaryComparison = "error"
reportAssertAlwaysTrue = "error"
reportSelfClsParameterName = "error"
reportImplicitStringConcatenation = "none"
reportUndefinedVariable = "error"
reportUnboundVariable = "error"
reportInvalidStubStatement = "error"
reportIncompleteStub = "error"
reportUnsupportedDunderAll = "error"
reportUnusedCallResult = "none"
reportUnusedCoroutine = "error"
